<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inkjin Price Estimator</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dropify@0.2.2/dist/js/dropify.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/dropify@0.2.2/dist/css/dropify.min.css">
</head>
<style>
    .logo {
        max-width: 100%;
        border-radius: 50%;
        animation: fading 2s infinite
    }

    .logo {
        opacity: 1;
        animation: fadeOutIn 2s infinite;
        /* Repeats infinitely */
    }

    @keyframes fadeOutIn {

        0%,
        100% {
            opacity: 1;
            /* Fully visible */
        }

        50% {
            opacity: 0;
            /* Fully hidden */
        }
    }

    .d-none {
        display: none;
    }

    .dropify-wrapper .dropify-message p {
        font-size: 18px !important;
    }

    .dropify {
        height: 100% !important;
    }
</style>

<body>
    <div class="loading-overlay">
        <div class="celtic-loader">
            <img src="logo.jpg" alt="Inkjin Logo" class="logo">
        </div>
        <p>Loading Inkjin Price Estimator</p>
    </div>

    <div class="container">
        <div class="header">
            <h1>Inkjin AI Price Estimator</h1>
            <button class="clear-btn d-none">Clear All</button>
        </div>

        <div class="calculator-form">

            <div id="ai-options">
                <div class="form-group">
                    <label>Upload Tattoo Reference</label>
                    <input type="file" class="dropify" id="tattooImage" accept="image/*">
                </div>
            </div>

            <div class="price-display">
                <h2>Upload Image to Reveal Pricing</h2>
            </div>

            <div class="form-group expert-artist d-none">
                <label>Artist Experience</label>
                <div class="experience-options">
                    <div class="experience-option">
                        <label for="beginner" class="experience-label">
                            <span class="exp-title">Beginner</span>
                            <span class="exp-years">0-2 years</span>
                            <span class="beginner-exp-status"></span>
                        </label>
                    </div>
                    <div class="experience-option">
                        <label for="intermediate" class="experience-label">
                            <span class="exp-title">Intermediate</span>
                            <span class="exp-years">3-5 years</span>
                            <span class="intermediate-exp-status"></span>
                        </label>
                    </div>
                    <div class="experience-option">
                        <label for="expert" class="experience-label">
                            <span class="exp-title">Expert</span>
                            <span class="exp-years">5+ years</span>
                            <span class="expert-exp-status"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
<script>
    const loadingOverlay = document.querySelector('.loading-overlay');
    const container = document.querySelector('.container');
    $(document).ready(function () {
        $('.dropify').dropify();

        // Handle image upload
        $('#tattooImage').on('change', function (event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onloadend = function () {
                const base64Image = reader.result.split(',')[1];
                $('.expert-artist').addClass('d-none');
                // Show loading state
                $('.price-display h2').text('Analyzing image...');

                $.ajax({
                    url: 'https://script.google.com/macros/s/AKfycbyPa15xMDZutzk75Fj6-ITpwvx35C04sepRIKe4wikpH573JGK9ZYB-O2zVXUFTbKxn6g/exec',
                    type: 'POST',
                    data: {
                        image: base64Image
                    },
                    success: function (response) {
                        console.log('Raw response:', response);
                        try {
                            const data = response.candidates[0].content.parts[0].text
                            updateUIWithResults(data.trim().replace(/^```json\n/, '').replace(/\n```$/, ''));
                        } catch (error) {
                            console.error('Error parsing JSON:', error);
                            $('.price-display h2').text('Error processing response. Please try again.');
                        }
                    },
                    error: function (error) {
                        console.error('Error:', error);
                        $('.price-display h2').text('Error analyzing image. Please try again.');
                    }
                });
            };

            if (file) {
                reader.readAsDataURL(file);
            }
        });

        function updateUIWithResults(responseText) {
            // Parse the JSON string from the response text
            let data = responseText;
            const json_data = JSON.parse(responseText);
            console.log(json_data);

            const indexes = Object.entries(json_data);

            const values = indexes.map((subArray) => subArray[1]);
            var style = '', size = '', color = '', placement = '', beginner = '', intermediate = '', expert = '';
            if (Array.isArray(values[0])) {
                style = values[0].join(', ')
            }
            else {
                style = values[0]
            }

            if (Array.isArray(values[1])) {
                size = values[1].join(', ')
            }
            else {
                size = values[1]
            }

            if (Array.isArray(values[2])) {
                color = values[2].join(', ')
            }
            else {
                color = values[2]
            }

            if (Array.isArray(values[3])) {
                placement = values[3].join(', ')
            }
            else {
                placement = values[3]
            }

            $('.beginner-exp-status').text(``)
            $('.intermediate-exp-status').text(``)
            $('.expert-exp-status').text(``)

            if (values[4]["Beginner (0-2 years)"]) {
                $('.expert-artist').removeClass('d-none');

                if (values[4]["Beginner (0-2 years)"].min) {
                    $('.expert-artist').removeClass('d-none');
                    $('.beginner-exp-status').text(`€` + `${values[4]["Beginner (0-2 years)"].min}` + ` - €` + `${values[4]["Beginner (0-2 years)"].max}`);
                    $('.intermediate-exp-status').text(`€` + `${values[4]["Intermediate (3-5 years)"].min}` + ` - €` + `${values[4]["Intermediate (3-5 years)"].max}`);
                    $('.expert-exp-status').text(`€` + `${values[4]["Expert (5+ years)"].min}` + ` - €` + `${values[4]["Expert (5+ years)"].max}`);
                }
                else {
                    $('.expert-artist').removeClass('d-none');
                    var beginner_min = values[4]["Beginner (0-2 years)"].split('-')[0].replace('$', '').replace('+', '').replace('USD', '');
                    var beginner_max = values[4]["Beginner (0-2 years)"].split('-')[1].replace('$', '').replace('+', '').replace('USD', '');
                    $('.beginner-exp-status').text(`€` + `${beginner_min}` + ` - €` + `${beginner_max}`);

                    var intermediate_min = values[4]["Intermediate (3-5 years)"].split('-')[0].replace('$', '').replace('+', '').replace('USD', '');
                    var intermediate_max = values[4]["Intermediate (3-5 years)"].split('-')[1].replace('$', '').replace('+', '').replace('USD', '');
                    $('.intermediate-exp-status').text(`€` + `${intermediate_min}` + ` - €` + `${intermediate_max}`);

                    var expert_min = values[4]["Expert (5+ years)"].split('-')[0].replace('$', '').replace('+', '').replace('USD', '');
                    var expert_max = (values[4]["Expert (5+ years)"].split('-')[1] == undefined ? '' : values[4]["Expert (5+ years)"].split('-')[1].replace('$', '').replace('+', '').replace('USD', ''));
                    expert_max == "" ? $('.expert-exp-status').text(`€` + `${expert_min}+`) : $('.expert-exp-status').text(`€` + `${expert_min}` + ` - €` + `${expert_max}`);
                }

            }
            else if (values[4]["Beginner"]) {
                $('.expert-artist').removeClass('d-none');

                if (values[4]["Beginner"].min) {
                    $('.expert-artist').removeClass('d-none');
                    $('.beginner-exp-status').text(`€` + `${values[4]["Beginner"].min}` + ` - €` + `${values[4]["Beginner"].max}`);
                    $('.intermediate-exp-status').text(`€` + `${values[4]["Intermediate"].min}` + ` - €` + `${values[4]["Intermediate"].max}`);
                    $('.expert-exp-status').text(`€` + `${values[4]["Expert"].min}` + ` - €` + `${values[4]["Expert"].max}`);
                }
                else {
                    $('.expert-artist').removeClass('d-none');
                    var beginner_min = values[4]["Beginner"].split('-')[0].replace('$', '').replace('+', '').replace('USD', '');
                    var beginner_max = values[4]["Beginner"].split('-')[1].replace('$', '').replace('+', '').replace('USD', '');
                    $('.beginner-exp-status').text(`€` + `${beginner_min}` + ` - €` + `${beginner_max}`);

                    var intermediate_min = values[4]["Intermediate"].split('-')[0].replace('$', '').replace('+', '').replace('USD', '');
                    var intermediate_max = values[4]["Intermediate"].split('-')[1].replace('$', '').replace('+', '').replace('USD', '');
                    $('.intermediate-exp-status').text(`€` + `${intermediate_min}` + ` - €` + `${intermediate_max}`);

                    var expert_min = values[4]["Expert"].split('-')[0].replace('$', '').replace('+', '').replace('USD', '');
                    var expert_max = (values[4]["Expert"].split('-')[1] == undefined ? '' : values[4]["Expert"].split('-')[1].replace('$', '').replace('+', '').replace('USD', ''));
                    expert_max == "" ? $('.expert-exp-status').text(`€` + `${expert_min}+`) : $('.expert-exp-status').text(`€` + `${expert_min}` + ` - €` + `${expert_max}`);
                }
            }
            // if (Array.isArray(values[4])) {
            //     beginner = values[4].join(', ')
            // }
            // else {
            //     beginner = values[4]
            // }
            $('.price-display h2').html(`
                <div>Style: ${style}</div>
                <div>Size: ${size}</div>
                <div>Color: ${color}</div>
                <div>Placement: ${placement}</div>  
            `);

        }

        loadingOverlay.style.opacity = '0';
        container.classList.add('visible');
        setTimeout(() => {
            loadingOverlay.style.display = 'none';
        }, 500);
    });
</script>

</html>